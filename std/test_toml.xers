// ============================================================================
// Test file for TOML parser
// ============================================================================
// Compile with: xersc.exe test_toml.xers -o test_toml.exe
// Run with: test_toml.exe
// ============================================================================

// Include the TOML parser (in real usage, use 'use std::toml')
// For testing, we inline it or expect it to be linked

fn main() {
    // Test TOML content
    let toml_content = alloc(512);

    // Build test TOML string manually
    // "[package]\nname = \"test-app\"\nversion = \"1.0.0\"\n\n[build]\noutput = \"build/app.exe\"\n"
    let pos = 0;

    // [package]
    poke(toml_content, pos, 91);  // [
    pos = pos + 1;
    poke(toml_content, pos, 112); // p
    pos = pos + 1;
    poke(toml_content, pos, 97);  // a
    pos = pos + 1;
    poke(toml_content, pos, 99);  // c
    pos = pos + 1;
    poke(toml_content, pos, 107); // k
    pos = pos + 1;
    poke(toml_content, pos, 97);  // a
    pos = pos + 1;
    poke(toml_content, pos, 103); // g
    pos = pos + 1;
    poke(toml_content, pos, 101); // e
    pos = pos + 1;
    poke(toml_content, pos, 93);  // ]
    pos = pos + 1;
    poke(toml_content, pos, 10);  // \n
    pos = pos + 1;

    // name = "test-app"
    poke(toml_content, pos, 110); // n
    pos = pos + 1;
    poke(toml_content, pos, 97);  // a
    pos = pos + 1;
    poke(toml_content, pos, 109); // m
    pos = pos + 1;
    poke(toml_content, pos, 101); // e
    pos = pos + 1;
    poke(toml_content, pos, 32);  // space
    pos = pos + 1;
    poke(toml_content, pos, 61);  // =
    pos = pos + 1;
    poke(toml_content, pos, 32);  // space
    pos = pos + 1;
    poke(toml_content, pos, 34);  // "
    pos = pos + 1;
    poke(toml_content, pos, 116); // t
    pos = pos + 1;
    poke(toml_content, pos, 101); // e
    pos = pos + 1;
    poke(toml_content, pos, 115); // s
    pos = pos + 1;
    poke(toml_content, pos, 116); // t
    pos = pos + 1;
    poke(toml_content, pos, 45);  // -
    pos = pos + 1;
    poke(toml_content, pos, 97);  // a
    pos = pos + 1;
    poke(toml_content, pos, 112); // p
    pos = pos + 1;
    poke(toml_content, pos, 112); // p
    pos = pos + 1;
    poke(toml_content, pos, 34);  // "
    pos = pos + 1;
    poke(toml_content, pos, 10);  // \n
    pos = pos + 1;

    // version = "1.0.0"
    poke(toml_content, pos, 118); // v
    pos = pos + 1;
    poke(toml_content, pos, 101); // e
    pos = pos + 1;
    poke(toml_content, pos, 114); // r
    pos = pos + 1;
    poke(toml_content, pos, 115); // s
    pos = pos + 1;
    poke(toml_content, pos, 105); // i
    pos = pos + 1;
    poke(toml_content, pos, 111); // o
    pos = pos + 1;
    poke(toml_content, pos, 110); // n
    pos = pos + 1;
    poke(toml_content, pos, 32);  // space
    pos = pos + 1;
    poke(toml_content, pos, 61);  // =
    pos = pos + 1;
    poke(toml_content, pos, 32);  // space
    pos = pos + 1;
    poke(toml_content, pos, 34);  // "
    pos = pos + 1;
    poke(toml_content, pos, 49);  // 1
    pos = pos + 1;
    poke(toml_content, pos, 46);  // .
    pos = pos + 1;
    poke(toml_content, pos, 48);  // 0
    pos = pos + 1;
    poke(toml_content, pos, 46);  // .
    pos = pos + 1;
    poke(toml_content, pos, 48);  // 0
    pos = pos + 1;
    poke(toml_content, pos, 34);  // "
    pos = pos + 1;
    poke(toml_content, pos, 10);  // \n
    pos = pos + 1;

    // \n (empty line)
    poke(toml_content, pos, 10);  // \n
    pos = pos + 1;

    // [build]
    poke(toml_content, pos, 91);  // [
    pos = pos + 1;
    poke(toml_content, pos, 98);  // b
    pos = pos + 1;
    poke(toml_content, pos, 117); // u
    pos = pos + 1;
    poke(toml_content, pos, 105); // i
    pos = pos + 1;
    poke(toml_content, pos, 108); // l
    pos = pos + 1;
    poke(toml_content, pos, 100); // d
    pos = pos + 1;
    poke(toml_content, pos, 93);  // ]
    pos = pos + 1;
    poke(toml_content, pos, 10);  // \n
    pos = pos + 1;

    // output = "app.exe"
    poke(toml_content, pos, 111); // o
    pos = pos + 1;
    poke(toml_content, pos, 117); // u
    pos = pos + 1;
    poke(toml_content, pos, 116); // t
    pos = pos + 1;
    poke(toml_content, pos, 112); // p
    pos = pos + 1;
    poke(toml_content, pos, 117); // u
    pos = pos + 1;
    poke(toml_content, pos, 116); // t
    pos = pos + 1;
    poke(toml_content, pos, 32);  // space
    pos = pos + 1;
    poke(toml_content, pos, 61);  // =
    pos = pos + 1;
    poke(toml_content, pos, 32);  // space
    pos = pos + 1;
    poke(toml_content, pos, 34);  // "
    pos = pos + 1;
    poke(toml_content, pos, 97);  // a
    pos = pos + 1;
    poke(toml_content, pos, 112); // p
    pos = pos + 1;
    poke(toml_content, pos, 112); // p
    pos = pos + 1;
    poke(toml_content, pos, 46);  // .
    pos = pos + 1;
    poke(toml_content, pos, 101); // e
    pos = pos + 1;
    poke(toml_content, pos, 120); // x
    pos = pos + 1;
    poke(toml_content, pos, 101); // e
    pos = pos + 1;
    poke(toml_content, pos, 34);  // "
    pos = pos + 1;
    poke(toml_content, pos, 10);  // \n
    pos = pos + 1;

    // Null terminate
    poke(toml_content, pos, 0);

    print_str("Parsing TOML...\n");

    let toml = parse_toml(toml_content);

    if toml == 0 {
        print_str("Error: Failed to parse TOML\n");
        return 1;
    }

    print_str("TOML parsed successfully!\n");

    // Debug print
    toml_debug_print(toml);

    // Test queries
    print_str("\nTesting queries:\n");

    // Build query strings
    let pkg_str = alloc(8);
    poke(pkg_str, 0, 112); // p
    poke(pkg_str, 1, 97);  // a
    poke(pkg_str, 2, 99);  // c
    poke(pkg_str, 3, 107); // k
    poke(pkg_str, 4, 97);  // a
    poke(pkg_str, 5, 103); // g
    poke(pkg_str, 6, 101); // e
    poke(pkg_str, 7, 0);

    let name_str = alloc(5);
    poke(name_str, 0, 110); // n
    poke(name_str, 1, 97);  // a
    poke(name_str, 2, 109); // m
    poke(name_str, 3, 101); // e
    poke(name_str, 4, 0);

    let result = toml_get_string(toml, pkg_str, name_str);
    if result != 0 {
        print_str("package.name = ");
        print_str(result);
        print_str("\n");
    } else {
        print_str("package.name not found\n");
    }

    print_str("\nTest completed!\n");
    return 0;
}
